<?php function check_db($mysqlcon,$lang,$dbname,$timezone,$currvers){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Check Database for updates...";function set_new_version($mysqlcon,$dbname,$timezone){if($mysqlcon->exec("UPDATE $dbname.config set currvers='1.0.1'")===false){echo " [failed]\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"An error happens due updating the Ranksystem Database: ",print_r($mysqlcon->errorInfo()),"\nCheck the database connection properties in other/dbconfig.php and check also the database permissions.\n";exit;}else{echo " [done]\n";}}function check_chmod($timezone){if(substr(sprintf('%o',fileperms('./icons/')),-4)!='0777'){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Write Permissions failed on folder \"icons\". Please give them a chmod 777 and try to start the Ranksystem again.\n";}if(substr(sprintf('%o',fileperms('./logs/')),-4)!='0777'){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Write Permissions failed on folder \"logs\". Please give them a chmod 777 and try to start the Ranksystem again.\n";}if(substr(sprintf('%o',fileperms('./avatars/')),-4)!='0777'){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Write Permissions failed on folder \"avatars\". Please give them a chmod 777 and try to start the Ranksystem again.\n";}}function old_files($timezone){if(is_file('install.php')){if(!unlink('install.php')){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Unnecessary file, please delete it from your webserver: install.php\n";}}if(is_file('list_rankup.php')){if(!unlink('list_rankup.php')){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Unnecessary file, please delete it from your webserver: list_rankup.php\n";}}if(is_file('lang.php')){if(!unlink('lang.php')){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Unnecessary file, please delete it from your webserver: lang.php\n";}}if(is_file('license.txt')){if(!unlink('license.txt')){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Unnecessary file, please delete it from your webserver: license.txt\n";}}if(is_file('jquerylib/jquery.ajaxQueue.js')){if(!unlink('jquerylib/jquery.ajaxQueue.js')){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Unnecessary file, please delete it from your webserver: jquerylib/jquery.ajaxQueue.js\n";}}if(is_file('jquerylib/jquery.autocomplete.js')){if(!unlink('jquerylib/jquery.autocomplete.js')){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Unnecessary file, please delete it from your webserver: jquerylib/jquery.autocomplete.js\n";}}if(is_file('jquerylib/jquery.autocomplete.min.js')){if(!unlink('jquerylib/jquery.autocomplete.min.js')){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Unnecessary file, please delete it from your webserver: jquerylib/jquery.autocomplete.min.js\n";}}if(is_file('jquerylib/jquery.bgiframe.min.js')){if(!unlink('jquerylib/jquery.bgiframe.min.js')){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Unnecessary file, please delete it from your webserver: jquerylib/jquery.bgiframe.min.js\n";}}if(is_file('jquerylib/jquery.css')){if(!unlink('jquerylib/jquery.css')){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Unnecessary file, please delete it from your webserver: jquerylib/jquery.css\n";}}if(is_file('jquerylib/localdata.js')){if(!unlink('jquerylib/localdata.js')){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Unnecessary file, please delete it from your webserver: jquerylib/localdata.js\n";}}if(is_file('jquerylib/thickbox.css')){if(!unlink('jquerylib/thickbox.css')){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Unnecessary file, please delete it from your webserver: jquerylib/thickbox.css\n";}}if(is_file('jquerylib/thickbox-compressed.js')){if(!unlink('jquerylib/thickbox-compressed.js')){echo DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Unnecessary file, please delete it from your webserver: jquerylib/thickbox-compressed.js\n";}}}if($currvers=="1.0.1"){echo " [done]\n";old_files($timezone);check_chmod($timezone);}elseif($currvers=="1.00"){set_new_version($mysqlcon,$dbname,$timezone);old_files($timezone);check_chmod($timezone);}elseif($currvers!="1.0.1"){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"Update the Ranksystem Database to version 1.01...";$errcount=1;if($mysqlcon->exec("ALTER TABLE $dbname.user ADD (boosttime bigint(11) NOT NULL default '0', rank bigint(11) NOT NULL default '0', platform text default NULL, nation text default NULL, version text default NULL, firstcon bigint(11) NOT NULL default '0', except int(1) NOT NULL default '0')")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"user\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}if($mysqlcon->exec("ALTER TABLE $dbname.config ADD (boost text default NULL, showcolas int(1) NOT NULL default '0', defchid bigint(11) NOT NULL default '0', timezone varchar(29) CHARACTER SET utf8 COLLATE utf8_unicode_ci, logpath varchar(200) CHARACTER SET utf8 COLLATE utf8_unicode_ci)")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"config\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}$logpath=addslashes(__DIR__."/logs/");if($mysqlcon->exec("ALTER TABLE $dbname.config MODIFY slowmode bigint(11) NOT NULL default '0'")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"config\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;if($mysqlcon->exec("UPDATE $dbname.config set defchid='0', timezome='Europe/Berlin', slowmode='0', logpath='$logpath'")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"config\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}}if($mysqlcon->exec("ALTER TABLE $dbname.groups ADD (icondate bigint(11) NOT NULL default '0')")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"groups\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}if($mysqlcon->exec("CREATE TABLE $dbname.server_usage (timestamp bigint(11) NOT NULL default '0', clients bigint(11) NOT NULL default '0', channel bigint(11) NOT NULL default '0')")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"server_usage\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}if($mysqlcon->exec("CREATE TABLE $dbname.user_snapshot (timestamp bigint(11) NOT NULL default '0', uuid varchar(29) CHARACTER SET utf8 COLLATE utf8_unicode_ci, count bigint(11) NOT NULL default '0', idle bigint(11) NOT NULL default '0')")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"user_snapshot\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}if($mysqlcon->exec("CREATE INDEX snapshot_timestamp ON $dbname.user_snapshot (timestamp)")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"snapshot_timestamp\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}if($mysqlcon->exec("CREATE TABLE $dbname.stats_server (total_user bigint(11) NOT NULL default '0', total_online_time bigint(13) NOT NULL default '0', total_online_month bigint(11) NOT NULL default '0', total_online_week bigint(11) NOT NULL default '0', total_active_time bigint(11) NOT NULL default '0', total_inactive_time bigint(11) NOT NULL default '0', country_nation_name_1 varchar(3) NOT NULL default '0', country_nation_name_2 varchar(3) NOT NULL default '0', country_nation_name_3 varchar(3) NOT NULL default '0', country_nation_name_4 varchar(3) NOT NULL default '0', country_nation_name_5 varchar(3) NOT NULL default '0', country_nation_1 bigint(11) NOT NULL default '0', country_nation_2 bigint(11) NOT NULL default '0', country_nation_3 bigint(11) NOT NULL default '0', country_nation_4 bigint(11) NOT NULL default '0', country_nation_5 bigint(11) NOT NULL default '0', country_nation_other bigint(11) NOT NULL default '0', platform_1 bigint(11) NOT NULL default '0', platform_2 bigint(11) NOT NULL default '0', platform_3 bigint(11) NOT NULL default '0', platform_4 bigint(11) NOT NULL default '0', platform_5 bigint(11) NOT NULL default '0', platform_other bigint(11) NOT NULL default '0', version_name_1 varchar(35) NOT NULL default '0', version_name_2 varchar(35) NOT NULL default '0', version_name_3 varchar(35) NOT NULL default '0', version_name_4 varchar(35) NOT NULL default '0', version_name_5 varchar(35) NOT NULL default '0', version_1 bigint(11) NOT NULL default '0', version_2 bigint(11) NOT NULL default '0', version_3 bigint(11) NOT NULL default '0', version_4 bigint(11) NOT NULL default '0', version_5 bigint(11) NOT NULL default '0', version_other bigint(11) NOT NULL default '0', server_status int(1) NOT NULL default '0', server_free_slots bigint(11) NOT NULL default '0', server_used_slots bigint(11) NOT NULL default '0', server_channel_amount bigint(11) NOT NULL default '0', server_ping bigint(11) NOT NULL default '0', server_packet_loss float (4,4), server_bytes_down bigint(11) NOT NULL default '0', server_bytes_up bigint(11) NOT NULL default '0', server_uptime bigint(11) NOT NULL default '0', server_id bigint(11) NOT NULL default '0', server_name text CHARACTER SET utf8 COLLATE utf8_unicode_ci, server_pass int(1) NOT NULL default '0', server_creation_date bigint(11) NOT NULL default '0', server_platform text CHARACTER SET utf8 COLLATE utf8_unicode_ci, server_weblist text CHARACTER SET utf8 COLLATE utf8_unicode_ci, server_version text CHARACTER SET utf8 COLLATE utf8_unicode_ci)")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"stats_server\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}if($mysqlcon->exec("CREATE TABLE $dbname.stats_user (uuid varchar(29) CHARACTER SET utf8 COLLATE utf8_unicode_ci PRIMARY KEY, removed int(1) NOT NULL default '0', rank bigint(11) NOT NULL default '0', total_connections bigint(11) NOT NULL default '0', count_week bigint(11) NOT NULL default '0', count_month bigint(11) NOT NULL default '0', idle_week bigint(11) NOT NULL default '0', idle_month bigint(11) NOT NULL default '0', achiev_count bigint(11) NOT NULL default '0', achiev_time bigint(11) NOT NULL default '0', achiev_connects bigint(11) NOT NULL default '0', achiev_battles bigint(11) NOT NULL default '0', achiev_time_perc int(3) NOT NULL default '0', achiev_connects_perc int(3) NOT NULL default '0', achiev_battles_perc int(3) NOT NULL default '0', battles_total bigint(11) NOT NULL default '0', battles_won bigint(11) NOT NULL default '0', battles_lost bigint(11) NOT NULL default '0', client_description text CHARACTER SET utf8 COLLATE utf8_unicode_ci, base64hash varchar(58) CHARACTER SET utf8 COLLATE utf8_unicode_ci, client_total_up bigint(15) NOT NULL default '0', client_total_down bigint(15) NOT NULL default '0')")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"stats_user\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}if($mysqlcon->exec("INSERT INTO $dbname.stats_server SET total_user='9999'")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"stats_server\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}if($mysqlcon->exec("CREATE TABLE $dbname.job_check (job_name varchar(20) CHARACTER SET utf8 COLLATE utf8_unicode_ci PRIMARY KEY, timestamp bigint(11) NOT NULL default '0')")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"job_check\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}if($mysqlcon->exec("INSERT INTO $dbname.job_check (job_name) VALUES ('calc_user_limit'),('calc_user_lastscan'),('check_update'),('check_clean')")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"job_check\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}if($mysqlcon->exec("CREATE TABLE $dbname.job_log (id bigint(11) AUTO_INCREMENT PRIMARY KEY, timestamp bigint(11) NOT NULL default '0', job_name varchar(20) CHARACTER SET utf8 COLLATE utf8_unicode_ci, status int(1) NOT NULL default '0', err_msg text CHARACTER SET utf8 COLLATE utf8_unicode_ci, runtime float (4,4))")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"job_log\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}if(($lastscan=$mysqlcon->query("SELECT timestamp FROM $dbname.lastscan"))===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"lastscan\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}else{$timestampls=$lastscan->fetchAll();$calc_user_lastscan=$timestampls[0]['timestamp'];if($mysqlcon->exec("UPDATE $dbname.job_check SET timestamp='$calc_user_lastscan' WHERE job_name='calc_user_lastscan'")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"job_check\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}elseif($mysqlcon->exec("DROP TABLE $dbname.lastscan")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"lastscan\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}}if(($lastupdate=$mysqlcon->query("SELECT timestamp FROM $dbname.upcheck"))===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"upcheck\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}else{$timestampuc=$lastupdate->fetchAll();$check_update=$timestampuc[0]['timestamp'];if($mysqlcon->exec("UPDATE $dbname.job_check SET timestamp='$check_update' WHERE job_name='check_update'")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"job_check\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}elseif($mysqlcon->exec("DROP TABLE $dbname.upcheck")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"upcheck\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}}if(($lastclean=$mysqlcon->query("SELECT timestamp FROM $dbname.cleanclients"))===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"upcheck\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}else{$timestamplc=$lastclean->fetchAll();$check_clean=$timestampls[0]['timestamp'];if($mysqlcon->exec("UPDATE $dbname.job_check SET timestamp='$check_clean' WHERE job_name='check_clean'")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"upcheck\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}elseif($mysqlcon->exec("DROP TABLE $dbname.cleanclients")===false){echo "\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"DB Update Error: table \"upcheck\" ",print_r($mysqlcon->errorInfo()),"\n";$errcount++;}}if($errcount==1){set_new_version($mysqlcon,$dbname,$timezone);old_files($timezone);check_chmod($timezone);}else{echo " [failed]\n",DateTime::createFromFormat('U.u',number_format(microtime(true),6,'.',''))->setTimeZone(new DateTimeZone($timezone))->format("Y-m-d H:i:s.u "),"An error happens due updating the Ranksystem Database!\nCheck the database connection properties in other/dbconfig.php and check also the database permissions.\n";exit;}}}?>